---
/**
 * Articles Menu Variant
 *
 * Enhanced menu that combines regular menu items with search and tag-based navigation.
 * Features:
 * - Renders regular menu items using StoryblokComponent
 * - Single-line search and filtering layout
 * - Top 3 most popular tags as clickable badges
 * - Remaining tags in a searchable combobox
 * - All search elements aligned in one responsive flex row
 *
 * Uses utilities for tag analytics loading and reusable components.
 */
import { storyblokEditable } from '@storyblok/astro';
import StoryblokComponent from '@storyblok/astro/StoryblokComponent.astro';
import { TagCombobox } from '~/components/TagCombobox';
import { SearchInput } from '~/components/SearchInput';
import TagBadge from '~/components/TagBadge.astro';
import { loadTagAnalytics, splitTags } from '~/utils/tagAnalytics';

const { blok } = Astro.props;
const { items } = blok;

// Load tag analytics and split into top/remaining (only 3 top tags now)
let tagAnalytics = null;
let topTags = [];
let remainingTags = [];

try {
  tagAnalytics = await loadTagAnalytics();
  if (tagAnalytics) {
    const split = splitTags(tagAnalytics, 3);
    topTags = split.topTags;
    remainingTags = split.remainingTags;
  }
} catch (error) {
  console.warn('Failed to load tag analytics for articles menu:', error);
}
---

<div {...storyblokEditable(blok)} class="space-y-6">
  {/* Regular menu items */}
  {items?.length > 0 && (
    <div class="flex flex-wrap gap-4">
      {items.map((item: any) => (
        <StoryblokComponent blok={item} />
      ))}
    </div>
  )}

  {/* Search and tag navigation */}
  {tagAnalytics && (
    <div>
      <!-- Header with stats -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-medium text-gray-700">Find Articles</h3>
        <span class="text-xs text-gray-500">
          {tagAnalytics.totalArticles} articles, {tagAnalytics.tags.length} topics
        </span>
      </div>

      <!-- Single-line search and filtering -->
      <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
        <!-- Search input -->
        <div class="w-full sm:flex-1 sm:min-w-0">
          <SearchInput
            placeholder="Search articles..."
            className="w-full"
            client:load
          />
        </div>

        <!-- Popular tags - hidden on mobile -->
        {topTags.length > 0 && (
          <div class="hidden sm:flex flex-wrap gap-2 shrink-0">
            {topTags.map((tag) => (
              <TagBadge tag={tag} />
            ))}
          </div>
        )}

        <!-- More tags combobox -->
        {remainingTags.length > 0 && (
          <div class="w-full sm:w-64 shrink-0">
            <TagCombobox
              tags={remainingTags}
              placeholder={`${remainingTags.length} more topics...`}
              emptyMessage="No topics found."
              client:load
            />
          </div>
        )}
      </div>
    </div>
  )}
</div>
